<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>开始使用</title>
    <link rel="stylesheet" href="../jeui/css/jeui.css">
    <link rel="stylesheet" href="../jeui/css/skin/jebox.css">
    <link rel="stylesheet" href="../jeui/css/skin/jedate.css">
    <!-- jQuery (Bootstrap 的 JavaScript 插件需要引入 jQuery) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="../jeui/js/modules/jeBox.js"></script>
    <script src="../jeui/js/modules/jeui.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <!-- 引入 Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    .userphoto{width: 60px;height: 60px;overflow: hidden;}
    #add_btn{

         }
    .HorizontalCenter{
        text-align: center;

        margin: auto;

        position: absolute;
        left: 50%;
        margin-left: -?px;
    }
    #self_order_button button{
        margin-right:20px;
    }
</style>
<body onload="init()">
    <nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">以物易物</a>
        </div>
        <div>

            <ul class="nav navbar-nav " id="loginandregister">
                <li><a href="/login">登录</a></li>
                <li><a href="#">注册</a></li>
            </ul>
            <ul class="nav navbar-nav " id="logined">
                <li><a href="/login" id="username_href"></a></li>
            </ul>
            <div class="">
                <form class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search" id="searchCondition">
                    </div>
                    <button type="button" class="btn btn-default" id="searchButton">搜索</button>
                </form>
            </div>
            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        个人信息
                        <b class="caret"></b>
                    </a>

                    <ul class="dropdown-menu">
                        <li><a href="#">设置</a></li>
                        <li><a href="#">我的钱包</a></li>
                    </ul>
                </li>
                <li><a href="#"><span class="glyphicon glyphicon-shopping-cart"></span>  购物车</a></li>
            </ul>
        </div>
    </div>
</nav>

<div id="order">
    <div class="row">
        <div id="seft_list" class="col-md-5">
            <table class="je-table"  skin="botline">
                <thead>
                    <tr>
                        <th width="100" align="left">物品编号</th>
                        <th width="80">图片</th>
                        <th>标题</th>
                        <th>收货地址</th>
                        <th>参考价格</th>
                        <th>介绍</th>
                        <th >操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="seft_orderItemSample">
                        <td id="seft_itemId">物品编号</td>
                        <td align="center" class="imgtd"><img src="../jeui/images/userphoto.jpg" class="userphoto"/></td>
                        <td id="seft_itemtitle">标题</td>
                        <td id="seft_itemShipAddress">收货地址</td>
                        <td id="seft_itemRefPrice">参考价格</td>
                        <td id="seft_itemDescription">介绍</td>
                        <td align="left">
                            <button class="je-btn je-bg-red" id="del_btn">删除</button>
                        </td>
                    </tr>
                    <p id="seft_justforappend"></p>
                </tbody>
            </table>
        </div>
        <div class="col-md-2"></div>
        <div id="owner_list" class="col-md-5">
            <table class="je-table"  skin="botline">
                <thead>
                <tr>
                    <th width="100" align="left">物品编号</th>
                    <th width="80">图片</th>
                    <th>标题</th>
                    <th>收货地址</th>
                    <th>参考价格</th>
                    <th>介绍</th>
                </tr>
                </thead>
                <tbody>
                    <tr id="owner_orderItemSample">
                        <td id="owner_itemId">物品编号</td>
                        <td align="center" class="imgtd"><img src="../jeui/images/userphoto.jpg" class="userphoto"/></td>
                        <td id="owner_itemtitle">标题</td>
                        <td id="owner_itemShipAddress">收货地址</td>
                        <td id="owner_itemRefPrice">参考价格</td>
                        <td id="owner_itemDescription">介绍</td>
                    </tr>
                    <p type="hidden" id="owner_justforappend"></p>
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div id="self_order_button" class="col-md-5"><div align="right" ><button class="je-btn" id="submit_btn">提交</button><button class="je-btn je-bg-green" id="confirm_btn">确认</button><button class="je-btn je-bg-orange" id="add_btn">添加</button><button class="je-btn" id="cancel_btn">取消</button></div></div>
        <div class="col-md-2"></div>
        <div id="" class="col-md-5"></div>
    </div>
</div>

</body>
<!--
	需要从localStorage获取的数据有
 	orderItemId 代表获取关于那个item的订单
 	chooseItemId 代表从box中选取自己的item作为订单的一部分

 -->
<script type="text/javascript">
    //localStorage.setItem("orderItemId",4);//测试数据
    var alreadyChosedItemId = new Array();//申请人选取的物品
    var itemOwnerItemId = new Array();//物主物品id列表
    var seft_orderItemSample = $("#seft_orderItemSample");//seft_orderItemSample组件
    seft_orderItemSample.hide();
    var owner_orderItemSample = $("#owner_orderItemSample")//owner_orderItemSample组件
    owner_orderItemSample.hide();
    localStorage.removeItem("chooseItemId");//保证自己显示的itemId是从iframe中选出来的。
    var orderItemId  = localStorage.getItem("orderItemId");//获取关于那个item的订单
    var testOrderId = 4;//测试数据
    var orderId = localStorage.getItem("orderOrderId"); //当前订单id。
    var receiver_address;
    var testReceiverAddress = "阳春帅气的东边二桥头";
	$(document).ready(function(){
		$("#add_btn").click(function(){
                jeBox.open({
                title:"mBox mobile页",
                type:'iframe',
                padding:"0",
                boxSize:["450px","80%"],
                content: "/choosebox.html",
                maskLock : true,
                    endfun: function(id, index){
                        //do something
                        var chooseItemId = localStorage.getItem("chooseItemId");
                        var isExist = false;
                        for (var i in alreadyChosedItemId){
                            if(alreadyChosedItemId[i] == chooseItemId){
                                isExist = true;
                            }
                        }
                        if (isExist == false && chooseItemId!= null){
                            //添加新元素
                            alreadyChosedItemId.push(chooseItemId);
                            reloadSeft_list();
                        }
                    }
                 });
                alert(alreadyChosedItemId);
			});
		$("#confirm_btn").click(function () {
            //确认订单http://localhost:8080//confirmOrder/14
            $.getJSON("/confirmOrder/"+orderId, function (result) {
                if (result.message=="succeed") {
                    alert("你已经确认订单，等待对方确定");
                    window.location.href='/order.html';
                }
            });
        });
		$("#submit_btn").click(function () {
            //提交
            var submitString = '{"orderId":"'+orderId+'",'+
                '"receiver_address":"'+testReceiverAddress+'",'+
                    '"selfOrderItemIdList":[';
            var selfOrderItemIdListString = "";
            for (var i = 0;i < alreadyChosedItemId.length;i++){
                selfOrderItemIdListString = selfOrderItemIdListString + '"' +alreadyChosedItemId[i] + '"';
                if(i != alreadyChosedItemId.length - 1){
                    selfOrderItemIdListString = selfOrderItemIdListString + ","
                }
            }
            selfOrderItemIdListString = selfOrderItemIdListString + "]}"
            submitString = submitString + selfOrderItemIdListString;
            alert("要提交的数据是"+submitString);
            $.ajaxSetup({
                contentType : 'application/json'
            });
            $.post("/submitOrderItem/"+orderId,submitString,function (json,status) {
                if (json.message = "succeed"){
                    alert("提交成功");
                }
            },"json");


        });
		$("#cancel_btn").click(function () {
            //取消按钮
        });
        initItemList();
		});
	function initItemList() {
        console.log("正在init");
	    initSeftItemList();
        initOwnerItemList();
        
    }
    function initSeftItemList(){
        $("[target='del']").remove();
        console.log("正在initSeftItemList");
        var isConfirm = false;
        var isChosed = false;
        $.getJSON("/getOrder/"+orderItemId, function (result) {
            if (result.message=="succeed") {
                //result.data.ownerOrderList
                orderId = result.data.barterOrder.barterOrderId;
                $.each(result.data.selfOrderList,function (index, value){
                    alreadyChosedItemId.push(value.itemId);
                    console.log("物品"+value.itemId+"的orderItemState："+value.orderItemState);
                    if (value.orderItemState == 1){
                        isChosed =true;
                    }
                    if (value.orderItemState == 2){
                        isConfirm =true;
                    }
                });
                if (isChosed){
                    $("#seft_list").css("border","2px solid #FFA042");
                }
                if(isConfirm){
                    $("#seft_list").css("border","2px solid #9AFF02");
                }
                for (var i = 0; i < alreadyChosedItemId.length;i++) {
                    console.log("alreadyChosedItemId"+alreadyChosedItemId[i]);
                    $.getJSON("/itemDetail/" + alreadyChosedItemId[i], function (result) {
                        if (result.message == "succeed") {
                            var newseft_orderItemSample = seft_orderItemSample.clone();
                            newseft_orderItemSample.attr("target","del");
                            newseft_orderItemSample.find("#seft_itemId").text(result.data.item.itemId);
                            newseft_orderItemSample.find("#seft_itemtitle").text(result.data.item.title);
                            newseft_orderItemSample.find("#seft_itemShipAddress").text(result.data.item.shipAddress);
                            newseft_orderItemSample.find("#seft_itemRefPrice").text(result.data.item.refPrice);
                            newseft_orderItemSample.find("#seft_itemDescription").text(result.data.item.description);
                            newseft_orderItemSample.find("#del_btn").click(function () {
                                var id = $(this).parent().parent().find("#seft_itemId").text();
                                console.log("del itemid:"+id);
                                alreadyChosedItemIdDelItem(parseInt(id));
                                for (var i in alreadyChosedItemId) {
                                    console.log("the ress alreadyChosedItemId item is:" +alreadyChosedItemId[i]);
                                }
                                $(this).parent().parent().remove();
                            });
                            newseft_orderItemSample.show();
                            seft_orderItemSample.after(newseft_orderItemSample);
                        }
                    });
                }
            }
        });
    }
    function initOwnerItemList() {
        $("[target='ownerlist_del']").remove();
        console.log("正在initOwnerItemList");
        var isConfirm = false;
        var isChosed = false;
        $.getJSON("/getOrder/"+orderItemId, function (result) {
            if (result.message=="succeed") {
                //result.data.ownerOrderList
                $.each(result.data.ownerOrderList,function (index, value){
                    itemOwnerItemId.push(value.itemId);
                    if (value.orderItemState == 1){
                        isChosed =true;
                    }
                    if (value.orderItemState == 2){
                        isConfirm =true;
                    }
                });
                if (isChosed){
                    $("#owner_list").css("border","2px solid #FFA042");
                }
                if(isConfirm){
                    $("#owner_list").css("border","2px solid #9AFF02");
                }
                for (var i = 0; i < itemOwnerItemId.length;i++) {
                    $.getJSON("/itemDetail/" + itemOwnerItemId[i], function (result) {
                        if (result.message == "succeed") {
                            var newOwner_orderItemSample = owner_orderItemSample.clone();
                            newOwner_orderItemSample.attr("target","ownerlist_del");
                            newOwner_orderItemSample.find("#owner_itemId").text(result.data.item.itemId);
                            newOwner_orderItemSample.find("#owner_itemtitle").text(result.data.item.title);
                            newOwner_orderItemSample.find("#owner_itemShipAddress").text(result.data.item.shipAddress);
                            newOwner_orderItemSample.find("#owner_itemRefPrice").text(result.data.item.refPrice);
                            newOwner_orderItemSample.find("#owner_itemDescription").text(result.data.item.description);
                            newOwner_orderItemSample.show();
                            owner_orderItemSample.after(newOwner_orderItemSample);
                        }
                    });
                }
            }
        });
    }
	function alreadyChosedItemIdDelItem(itemId) {
        for (var i in alreadyChosedItemId){
            if (alreadyChosedItemId[i] == itemId){
                alreadyChosedItemId.splice(i,1);
            }
        }

    }
	function reloadSeft_list() {
        var isConfirm = true;
        var isChosed = true;
        for (var i = 0; i < alreadyChosedItemId.length;i++){
            $("[target='del']").remove();
            $.getJSON("/itemDetail/" + alreadyChosedItemId[i], function (result) {
                if (result.message=="succeed") {
                    /** "item": {
                                "itemId": 1,
                                "uid": 1,
                                "title": "item1_title",
                                "shipAddress": "asdasdasd",
                                "refPrice": 1000,
                                "classificationId": 1,
                                "stock": 1,
                                "ison": 1,
                                "description": null
                            }
                     * */
                    var newseft_orderItemSample = seft_orderItemSample.clone();
                    newseft_orderItemSample.attr("target","del");
                    newseft_orderItemSample.find("#seft_itemId").text(result.data.item.itemId);
                    newseft_orderItemSample.find("#seft_itemtitle").text(result.data.item.title);
                    newseft_orderItemSample.find("#seft_itemShipAddress").text(result.data.item.shipAddress);
                    newseft_orderItemSample.find("#seft_itemRefPrice").text(result.data.item.refPrice);
                    newseft_orderItemSample.find("#seft_itemDescription").text(result.data.item.description);
                    newseft_orderItemSample.find("#del_btn").click(function () {
                        var id = $(this).parent().parent().find("#seft_itemId").text();
                        console.log("del itemid:"+id);
                        alreadyChosedItemIdDelItem(parseInt(id));
                        for (var i in alreadyChosedItemId) {
                            console.log("the ress alreadyChosedItemId item is:" +alreadyChosedItemId[i]);
                        }
                        $(this).parent().parent().remove();
                    });
                    if(result.data.item.orderItemState != 1){
                        isChosed = false;
                        if(result.data.item.orderItemState != 2){
                            isConfirm = false;
                        }
                    }
                    newseft_orderItemSample.show();
                    seft_orderItemSample.after(newseft_orderItemSample);
                }
            });

            }
            if (isChosed){
                $("#seft_list").css("border:solid 2px #FFA042");
            }
            if(isConfirm){
                $("#seft_list").css("border:solid 2px #9AFF02");
            }
    }
	</script>
<script type="application/javascript">
    var logined = $("#logined");//已登录显示的组件
    logined.hide();
    var loginandregister = $("#loginandregister");
    var username_href = $("#username_href");
    var username = "";
    var phone = "";
    var email = "";
    var balance =　"";
    function init(){
        $.post("/getUI","",function (json,status) {
            var obj = json;
            if(obj.message == "isLogin"){
                username = obj.data.username;
                phone = obj.data.phone;
                email = obj.data.email;
                balance = obj.data.balance;
                loginandregister.hide();
                document.getElementById("username_href").innerHTML = "Hi,"+username+"!";
                logined.show();
            }else if (obj.message == "isNotLogin"){
            }
        },"json");
        $("#searchButton").click(function () {
            var searchCondition = $("#searchCondition").val();
            alert(searchCondition);
            localStorage.setItem("searchCondition",searchCondition);
            window.location.href='/page_search.html';
        });
    }
</script>
</html>